#!/bin/bash
set -e
set -u
set -o pipefail


###############readme
#this script will take demultiplexed fastq files (from Guppy) do the following alignment with NGMLR and variants calling with Clair

#usage: yeah /path/to/folder_with_fastq  -w /path/to/folder_for_output /path/to/reference_for_alignment /path/to/bed_file_with_full_GBA_coverage

#before starting you need all dependencies installed and added to PATH (NGMLR, bgzip, tabiz, annovar, whatshap, nanopolish, vcftools, bcftools)

###########setting options
while getopts 'w:' OPTION
do
    case "$OPTION" in
	w)
	    WD="$OPTARG"
	    ;;
	?)
	echo "must provide option -w" >&2
	;;
    esac
done

	    


echo preparing files

mkdir $WD/mergedfastq $WD/aligned $WD/sorted_indexed $WD/clair $WD/downsampled_bams $WD/finaloutput $WD/coverage $WD/downsampled_sorted_indexed $WD/phased

for D in $1/*
do

    find $D -name *.fastq -exec cat {} \;  > $WD/mergedfastq/${D#"$(dirname "$D")"/}.fastq

done

echo aligning

for f in $WD/mergedfastq/*.fastq
do
    
    ngmlr \
	-t 8 \
	-r $3 \
	-q $f \
	-o $WD/aligned/$(basename $f .fastq).sam \
	-x ont

done

echo sorting and indexing

for f in $WD/aligned/*.sam
do

    samtools sort $f \
	     -o $WD/sorted_indexed/$(basename $f .sam).bam

done

for f in $WD/sorted_indexed/*.bam
do

    samtools index $f

done

echo adjusting coverage

for f in $WD/sorted_indexed/*.bam
do

        var="$(coverageBed -mean -a $4 -b $f | awk '{print $4}')"                                             
	int=${var%.*}

	    if [ $int -gt 550 ]                                                         
                                                                                
    then                                                                        

	var1="$(echo "1/($var/550)" | bc -l)"                                   
        samtools view -s $var1 -b $f -o $WD/downsampled_bams/${f#"$(dirname "$f")"/}
                                                                                
    else                                                                        

	cp $f $WD/downsampled_bams/${f#"$(dirname "$f")"/}                        
                                                                                
    fi                                                                          
                                                                                
done

echo sorting and indexing 2

for f in $WD/downsampled_bams/*.bam
do

    samtools sort $f \
	     -o $WD/downsampled_sorted_indexed/${f#"$(dirname "$f")"/}

done

for f in $WD/downsampled_sorted_indexed/*.bam
do

    samtools index $f

done

echo calling variants


CONDA_BASE=$(conda info --base)
source $CONDA_BASE/etc/profile.d/conda.sh

conda activate clair-env

CLAIR=/home/minionpc/Clair/clair.py                                                                                                                                               
MODEL=/home/minionpc/Clair/ont/model                                                                                                                                              
REFERENCE_FASTA_FILE_PATH=$3                                                                                                                                 
CONTIG_NAME=1

for f in $WD/sorted_indexed/*.bam                                                                                                                                                    
do                                                                                                                                                                                

    VARIANT_CALLING_OUTPUT_PATH=$WD/clair/$(basename $f .bam).vcf                                                                                                                              
    BAM_FILE_PATH=$f                                                                                                                                                              
    SAMPLE_NAME=$(basename $f .bam)                                                                                                                                            
    python $CLAIR callVarBam --chkpnt_fn "$MODEL" --ref_fn "$REFERENCE_FASTA_FILE_PATH" --bam_fn "$BAM_FILE_PATH" --ctgName "$CONTIG_NAME" --sampleName "$SAMPLE_NAME" --call_fn "$VARIANT_CALLING_OUTPUT_PATH" --minCoverage 20 --threshold 0.2 --delay 2 --ctgStart 155202239 --ctgEnd 155216653

done

conda deactivate

echo phasing

for f in $WD/clair/*.vcf
do

    sample=$(basename $f .vcf)

    whatshap phase $f $WD/sorted_indexed/$sample.bam \
	     --reference $3 \
	     -o $WD/phased/$sample.vcf \
	     --ignore-read-groups

done

echo finalising

for f in  $WD/phased/*.vcf                                                                                      
do                                                                                                        

    bgzip $f                                                                                              
                                                                                                          
done                                                                                                      
                                                                                                          
for f in $WD/phased/*gz                                                                                         
do                                                                                                        

    tabix -p vcf $f                                                                                       
                                                                                                          
done                                                                                                      
                                                                                                          
vcf-merge $WD/phased/*.gz > $WD/finaloutput/final.vcf

for f in $WD/downsampled_sorted_indexed/*.bam
do

    coverageBed \
	-mean \
	-header \
	-a $4 \
	-b $f \
	> $WD/coverage/$(basename $f .bam).vcf

done

more $WD/coverage/* | cat > $WD/finaloutput/coverage.vcf

echo oh yeah!
